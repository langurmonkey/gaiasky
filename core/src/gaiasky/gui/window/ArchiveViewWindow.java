/*
 * Copyright (c) 2023-2024 Gaia Sky - All rights reserved.
 *  This file is part of Gaia Sky, which is released under the Mozilla Public License 2.0.
 *  You may use, distribute and modify this code under the terms of MPL2.
 *  See the file LICENSE.md in the project root for full license details.
 */

package gaiasky.gui.window;

import com.badlogic.gdx.Gdx;
import com.badlogic.gdx.Net.HttpMethods;
import com.badlogic.gdx.Net.HttpRequest;
import com.badlogic.gdx.Net.HttpResponse;
import com.badlogic.gdx.Net.HttpResponseListener;
import com.badlogic.gdx.net.HttpStatus;
import com.badlogic.gdx.scenes.scene2d.Actor;
import com.badlogic.gdx.scenes.scene2d.Stage;
import com.badlogic.gdx.scenes.scene2d.ui.HorizontalGroup;
import com.badlogic.gdx.scenes.scene2d.ui.ImageButton;
import com.badlogic.gdx.scenes.scene2d.ui.Skin;
import com.badlogic.gdx.scenes.scene2d.ui.Table;
import com.badlogic.gdx.utils.Align;
import com.badlogic.gdx.utils.JsonReader;
import com.badlogic.gdx.utils.JsonValue;
import gaiasky.GaiaSky;
import gaiasky.scene.view.FocusView;
import gaiasky.util.Constants;
import gaiasky.util.Logger;
import gaiasky.util.Logger.Log;
import gaiasky.util.TextUtils;
import gaiasky.util.i18n.I18n;
import gaiasky.util.scene2d.Link;
import gaiasky.util.scene2d.OwnLabel;
import gaiasky.util.scene2d.OwnScrollPane;
import gaiasky.util.scene2d.OwnTextTooltip;

import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.Reader;
import java.nio.charset.StandardCharsets;

public class ArchiveViewWindow extends GenericDialog {
    private static final Log logger = Logger.getLogger(ArchiveViewWindow.class);

    private static final String separator = "\n";

    private Table table;
    private OwnScrollPane scroll;

    private float pad;

    private FocusView st;
    private boolean updating = false;

    public ArchiveViewWindow(Stage stage, Skin skin) {
        super(I18n.msg("gui.data.catalog", "Gaia", "?"), skin, stage);

        setAcceptText(I18n.msg("gui.close"));
        setModal(false);

        // Build
        buildSuper();

    }

    public boolean isUpdating() {
        return updating;
    }

    public void update(FocusView st) {
        updating = true;
        this.st = st;

        this.getTitleLabel().setText(I18n.msg("gui.data.catalog", "Gaia", st.getName()));

        table.clear();
        requestData(new GaiaDataListener(st));
    }

    @Override
    protected void build() {
        this.pad = 8f;

        /* TABLE and SCROLL */
        table = new Table(skin);
        table.pad(pad);
        scroll = new OwnScrollPane(table, skin, "minimalist-nobg");
        scroll.setFadeScrollBars(false);
        scroll.setScrollingDisabled(true, false);
        scroll.setOverscroll(false, false);
        scroll.setSmoothScrolling(true);

        content.add(scroll);
        getTitleTable().align(Align.left);

        pack();
    }

    @Override
    protected boolean accept() {
        // Nothing
        return true;
    }

    @Override
    protected void cancel() {
        // Nothing
    }

    @Override
    public void dispose() {

    }

    private void requestData(GaiaDataListener listener) {
        if (st.getId() > 5000000) {
            this.getTitleLabel().setText(I18n.msg("gui.data.catalog", "Gaia", st.getName()));
            // Gaia source ID
            getDataBySourceId(st.getId(), listener);
            return;
        } else if (st.getHip() > 0) {
            this.getTitleLabel().setText(I18n.msg("gui.data.catalog", "Hipparcos", st.getName()));
            // HIP
            getDataByHipId(st.getHip(), listener);
            return;
        }
        listener.notFound();
    }

    private void getDataBySourceId(long sourceid, GaiaDataListener listener) {
        getTAPData(Constants.URL_GAIA_JSON_SOURCE + sourceid, false, "json", listener);
    }

    private void getDataByHipId(int hip, GaiaDataListener listener) {
        getTAPData(Constants.URL_HIP_JSON_SOURCE + hip, true, "json", listener);
    }

    private void getTAPData(String url, boolean hip, final String format, final GaiaDataListener listener) {
        HttpRequest request = new HttpRequest(HttpMethods.GET);
        request.setUrl(url);
        request.setTimeOut(5000);

        Gdx.net.sendHttpRequest(request, new HttpResponseListener() {
            @Override
            public void handleHttpResponse(HttpResponse httpResponse) {
                if (httpResponse.getStatus().getStatusCode() == HttpStatus.SC_OK) {
                    // Ok
                    listener.ok(isToArray(httpResponse.getResultAsStream(), format), hip);
                } else {
                    // Ko with code
                    listener.ko(httpResponse.getStatus().toString());
                }

            }

            @Override
            public void failed(Throwable t) {
                // Failed
                listener.ko();
            }

            @Override
            public void cancelled() {
                // Cancelled
                listener.ko();
            }
        });
    }

    public String trim(String stringToTrim, String stringToRemove) {
        String answer = stringToTrim;

        while (answer.startsWith(stringToRemove)) {
            answer = answer.substring(stringToRemove.length());
        }

        while (answer.endsWith(stringToRemove)) {
            answer = answer.substring(0, answer.length() - stringToRemove.length());
        }

        return answer;
    }

    private String slurp(final InputStream is, final int bufferSize) {
        final char[] buffer = new char[bufferSize];
        final StringBuilder out = new StringBuilder();
        try (Reader in = new InputStreamReader(is, StandardCharsets.UTF_8)) {
            for (; ; ) {
                int rsz = in.read(buffer, 0, buffer.length);
                if (rsz < 0)
                    break;
                out.append(buffer, 0, rsz);
            }
        } catch (IOException ex) {
            logger.error(ex);
        }
        return out.toString();
    }

    private String[][] isToArray(InputStream is, String format) {
        String data = slurp(is, 2064);

        if (format.equalsIgnoreCase("csv")) {
            // Parse CSV.
            String[] rows = data.split(separator);
            if (rows.length <= 1) {
                return null;
            }

            String[][] matrix = new String[rows.length][];

            int r = 0;
            for (String row : rows) {
                String[] tokens = row.split(",");
                int i = 0;
                for (String token : tokens) {
                    token = token.trim();
                    tokens[i] = trim(token, "\"");
                    i++;
                }

                matrix[r] = tokens;
                r++;
            }

            return matrix;
        } else if (format.equalsIgnoreCase("json")) {
            // Parse JSON.
            JsonReader json = new JsonReader();
            JsonValue root = json.parse(data);

            JsonValue metadata = root.child;
            int size = metadata.size;
            JsonValue column = metadata.child;
            String[] colnames = new String[size];
            String[] descriptions = new String[size];
            String[] values = new String[size];

            int i = 0;
            do {
                colnames[i] = column.getString("name");
                descriptions[i] = column.getString("description") + (column.has("unit") ? " [" + column.getString("unit") + "]" : "");
                i++;
                column = column.next;
            } while (column != null);

            JsonValue datacol = metadata.next.child.child;
            i = 0;
            do {
                values[i] = datacol.asString();
                i++;
                datacol = datacol.next;
            } while (datacol != null);

            String[][] matrix = new String[3][];
            matrix[0] = colnames;
            matrix[1] = values;
            matrix[2] = descriptions;
            return matrix;
        }
        return null;
    }

    private class GaiaDataListener {
        private final FocusView st;

        public GaiaDataListener(FocusView st) {
            this.st = st;
        }

        public void ok(final String[][] data, boolean hip) {
            GaiaSky.postRunnable(() -> {

                HorizontalGroup links = new HorizontalGroup();
                links.align(Align.center);
                links.pad(pad / 2f, pad / 2f, pad / 2f, pad / 2f);
                links.space(pad);

                if (hip)
                    links.addActor(new Link(I18n.msg("gui.data.json"), skin, Constants.URL_HIP_JSON_SOURCE + st.getHip()));
                else {
                    links.addActor(new Link(I18n.msg("gui.data.json"), skin, Constants.URL_GAIA_JSON_SOURCE + st.getId()));
                    links.addActor(new OwnLabel("|", skin));
                    links.addActor(new Link(I18n.msg("gui.data.archive"), skin, Constants.URL_GAIA_WEB_SOURCE + st.getId()));
                }

                table.add(links).colspan(2).padTop(pad * 2).padBottom(pad * 2);
                table.row();

                table.add(new OwnLabel(I18n.msg("gui.data.name"), skin, "big")).padLeft(pad * 2).left();
                table.add(new OwnLabel(st.getName(), skin, "big")).padLeft(pad * 2).padRight(pad * 2).left();
                table.row().padTop(pad * 2);
                for (int col = 0; col < data[0].length; col++) {
                    Actor first;

                    if (data.length <= 2) {
                        first = new OwnLabel(data[0][col], skin, "big");
                    } else {
                        HorizontalGroup hg = new HorizontalGroup();
                        hg.space(8);
                        ImageButton tooltip = new ImageButton(skin, "tooltip");
                        tooltip.addListener(new OwnTextTooltip(data[0][col], skin));
                        // Label.
                        var text = TextUtils.capString(data[2][col], 70);
                        var label = new OwnLabel(text, skin, "header-blue");
                        label.addListener(new OwnTextTooltip(data[2][col], skin));
                        label.setWidth(Math.max(label.getWidth(), 880f));

                        hg.addActor(label);
                        hg.addActor(tooltip);

                        first = hg;

                    }

                    table.add(first).padLeft(pad * 2).left();
                    table.add(new OwnLabel(data[1][col], skin, "big")).padLeft(pad * 2f).padRight(pad * 2f).left();
                    left();
                    table.row();
                }
                finish();
            });
        }

        public void ko() {
            // Error getting data
            GaiaSky.postRunnable(() -> {
                String msg = I18n.msg("error.gaiacatalog.data", st.getName());
                table.add(new OwnLabel(msg, skin, "big"));
                finish();
            });
        }

        public void ko(String error) {
            // Error
            GaiaSky.postRunnable(() -> {
                table.add(new OwnLabel(error, skin, "big"));
                finish();
            });
        }

        public void notFound() {
            // Not found
            String msg = I18n.msg("error.gaiacatalog.notfound", st.getName());
            table.add(new OwnLabel(msg, skin, "big"));
            finish();
        }

        private void finish() {
            table.pack();
            scroll.setWidth(table.getWidth() + scroll.getStyle().vScroll.getMinWidth());
            scroll.setHeight(Math.min(table.getHeight(), Gdx.graphics.getHeight() * 0.95f) + pad);
            pack();
            updating = false;
        }

    }

}
